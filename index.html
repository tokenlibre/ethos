<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Triangulador Â· No RecÃ­proco (Sheets)</title>
<style>
  body{margin:0;background:#0b1220;color:#e5e7eb;font:15px system-ui}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  .card{background:#0f172a;border:1px solid #1c2b3c;border-radius:12px;padding:12px;margin-bottom:12px}
  input,select,button{border-radius:8px;border:1px solid #1c2b3c;background:#0a1320;color:#e5e7eb;padding:6px 10px;font:inherit}
  .btn{cursor:pointer;background:#0e2333}
  .btn-ok{background:#0f2b23}
  .mono{font-family:monospace}
  .chip{display:inline-block;margin:2px 6px 2px 0;padding:4px 8px;border:1px solid #1c2b3c;border-radius:999px;font-size:12px}
</style>
</head>
<body>
<header class="wrap"><h1>ðŸ”º Triangulador (no recÃ­proco) â€” Google Sheets</h1></header>
<main class="wrap">
  <section class="card">
    <h3>Usuarios</h3>
    <form id="formUser"><input id="userName" placeholder="@usuario" required><button class="btn-ok">AÃ±adir</button></form>
    <div id="userList"></div>
  </section>
  <section class="card">
    <h3>Enlaces (A âžœ B)</h3>
    <form id="formEdge"><select id="fromUser" required></select> âžœ <select id="toUser" required></select><button class="btn-ok">Crear</button></form>
    <div id="edgeTableWrap"></div>
  </section>
  <section class="card">
    <h3>Consulta</h3>
    <div><select id="focusUser" multiple size="6" style="min-width:240px"></select> <button class="btn" id="btnAnalyze">Analizar</button></div>
    <div id="analysis"></div>
  </section>
</main>
<script>
// âœ… Tu API de Google Apps Script (con /exec)
const API_URL = 'https://script.google.com/macros/s/AKfycbwDkMZoisVe8wBuPBP_wO4ZN0pDCJtJN32WhB_TQy4Uc3V9iVIIQbFNUBnGxBjpX7vaSw/exec';

const $=s=>document.querySelector(s);
let state={users:[],edges:[]};

async function apiGet(action='getState'){
  const u = new URL(API_URL);
  u.searchParams.set('action', action);
  const res = await fetch(u.toString(), { method:'GET' });
  const json = await res.json();
  if(!json.ok) throw new Error(json.error||'GET error');
  return json;
}
async function apiPost(action, payload={}){
  const res = await fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action, ...payload})
  });
  const json = await res.json();
  if(!json.ok) throw new Error(json.error||'POST error');
  return json;
}

async function loadState(){
  const data = await apiGet('getState');
  state.users = data.users||[];
  state.edges = data.edges||[];
  renderUsers(); renderEdges(); fillSelects();
}

function hasEdge(a,b){ return state.edges.some(e=>e.from===a && e.to===b); }
function hasAnyRelation(a,b){ return hasEdge(a,b) || hasEdge(b,a); }
function outNeighbors(u){ return state.edges.filter(e=>e.from===u).map(e=>e.to); }
function inNeighbors(u){ return state.edges.filter(e=>e.to===u).map(e=>e.from); }

function renderUsers(){ $('#userList').innerHTML=state.users.map(u=>`<span class="mono">${u}</span> <button onclick="removeUser('${u}')">x</button>`).join(' '); }
function renderEdges(){ $('#edgeTableWrap').innerHTML=state.edges.map(e=>`<div class="mono">${e.from} âžœ ${e.to} <button onclick=\"removeEdge('${e.from}','${e.to}')\">x</button></div>`).join('')||'<div class="mono">(sin enlaces)</div>'; }
function fillSelects(){ ['fromUser','toUser','focusUser'].forEach(id=>{$('#'+id).innerHTML=state.users.map(u=>`<option value=\"${u}\">${u}</option>`).join('');}); }

function norm(u){ u=(u||'').trim(); if(!u) return ''; if(!u.startsWith('@')) u='@'+u; return u.toLowerCase(); }

async function ensureUser(u){ u=norm(u); if(!u) return; await apiPost('addUser',{user:u}); await loadState(); }
async function addEdge(a,b){ a=norm(a); b=norm(b); if(!a||!b) return; await apiPost('addEdge',{from:a,to:b}); await loadState(); }
async function removeUser(u){ await apiPost('removeUser',{user:u}); await loadState(); }
async function removeEdge(a,b){ await apiPost('removeEdge',{from:a,to:b}); await loadState(); }

function candidatePartners(u){ return state.users.filter(v=> v!==u && !hasAnyRelation(u,v)); }

function analyze(){ const sel=Array.from($('#focusUser').selectedOptions).map(o=>o.value); $('#analysis').innerHTML=''; sel.forEach(u=>{ $('#analysis').innerHTML+=`<h4>${u}</h4><div>Ha escrito a: ${outNeighbors(u).map(x=>`<span class=\"chip\">${x}</span>`).join(' ')||'(ninguno)'}<br>Ha recibido de: ${inNeighbors(u).map(x=>`<span class=\"chip\">${x}</span>`).join(' ')||'(ninguno)'}<br><b>Puede interactuar con:</b> ${candidatePartners(u).map(x=>`<span class=\"chip\">${x}</span>`).join(' ')||'(ninguno)'} </div>`; }); }

$('#formUser').addEventListener('submit',async e=>{e.preventDefault();const v=$('#userName').value; $('#userName').value=''; try{ await ensureUser(v);}catch(err){ alert(err.message); }});
$('#formEdge').addEventListener('submit',async e=>{e.preventDefault(); try{ await addEdge($('#fromUser').value,$('#toUser').value);}catch(err){ alert(err.message); }});
$('#btnAnalyze').addEventListener('click',analyze);

loadState();
</script>
</body>
</html>
