<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Triangulador Â· No RecÃ­proco (Supabase)</title>
<style>
  body{margin:0;background:#0b1220;color:#e5e7eb;font:15px system-ui}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  .card{background:#0f172a;border:1px solid #1c2b3c;border-radius:12px;padding:12px;margin-bottom:12px}
  input,select,button{border-radius:8px;border:1px solid #1c2b3c;background:#0a1320;color:#e5e7eb;padding:6px 10px;font:inherit}
  .btn{cursor:pointer;background:#0e2333}
  .btn-ok{background:#0f2b23}
  .mono{font-family:monospace}
  .chip{display:inline-block;margin:2px 6px 2px 0;padding:4px 8px;border:1px solid #1c2b3c;border-radius:999px;font-size:12px}
</style>
</head>
<body>
<header class="wrap"><h1>ðŸ”º Triangulador (no recÃ­proco) â€” Supabase</h1></header>
<main class="wrap">
  <section class="card">
    <h3>Usuarios</h3>
    <form id="formUser"><input id="userName" placeholder="@usuario" required><button class="btn-ok">AÃ±adir</button></form>
    <div id="userList"></div>
  </section>
  <section class="card">
    <h3>Enlaces (A âžœ B)</h3>
    <form id="formEdge"><select id="fromUser" required></select> âžœ <select id="toUser" required></select><button class="btn-ok">Crear</button></form>
    <div id="edgeTableWrap"></div>
  </section>
  <section class="card">
    <h3>Consulta</h3>
    <div><select id="focusUser" multiple size="6" style="min-width:240px"></select> <button class="btn" id="btnAnalyze">Analizar</button></div>
    <div id="analysis"></div>
  </section>
</main>

<!-- Supabase JS (v2) -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://xlgejufrchzrjwsqbosw.supabase.co';          // ej: https://abcd.supabase.co
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsZ2VqdWZyY2h6cmp3c3Fib3N3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNDMyNjEsImV4cCI6MjA3MzYxOTI2MX0.v9FKgKQZ4_v3D4f_uLFhpMlOR6v578d91bU_HvR05_s';  // desde Settings â†’ API
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = s => document.querySelector(s);
let state = { users: [], edges: [] };

function norm(u){
  u = (u || '').trim();
  if(!u) return '';
  if(!u.startsWith('@')) u = '@' + u;
  return u.toLowerCase();
}

async function loadState(){
  const { data: users, error: e1 } = await supabase.from('users').select('handle').order('handle');
  if(e1) throw e1;
  const { data: edges, error: e2 } = await supabase.from('edges').select('"from","to"').order('from');
  if(e2) throw e2;
  state.users = (users || []).map(r => r.handle);
  state.edges = edges || [];
  renderUsers(); renderEdges(); fillSelects();
}

function hasEdge(a,b){ return state.edges.some(e => e.from===a && e.to===b); }
function hasAnyRelation(a,b){ return hasEdge(a,b) || hasEdge(b,a); }
function outNeighbors(u){ return state.edges.filter(e => e.from===u).map(e => e.to); }
function inNeighbors(u){ return state.edges.filter(e => e.to===u).map(e => e.from); }

function renderUsers(){
  $('#userList').innerHTML = state.users
    .map(u => `<span class="mono">${u}</span> <button onclick="removeUser('${u}')">x</button>`)
    .join(' ');
}
function renderEdges(){
  $('#edgeTableWrap').innerHTML = state.edges
    .map(e => `<div class="mono">${e.from} âžœ ${e.to} <button onclick="removeEdge('${e.from}','${e.to}')">x</button></div>`)
    .join('') || '<div class="mono">(sin enlaces)</div>';
}
function fillSelects(){
  ['fromUser','toUser','focusUser'].forEach(id => {
    const el = $('#'+id);
    if(!el) return;
    el.innerHTML = state.users.map(u => `<option value="${u}">${u}</option>`).join('');
  });
}

async function ensureUser(u){
  u = norm(u); if(!u) return;
  const { error } = await supabase.from('users').upsert([{ handle: u }], { onConflict: 'handle' });
  if(error) throw error;
}

async function addEdge(a,b){
  a = norm(a); b = norm(b); if(!a || !b) return;
  // asegÃºrate de que existen los usuarios (FK)
  await ensureUser(a); await ensureUser(b);
  const { error } = await supabase.from('edges').insert({ from: a, to: b });
  if(error){
    // 23505 = unique_violation (duplicado o recÃ­proco debido al Ã­ndice ux_edges_unordered_pair)
    if(error.code === '23505') alert('Ya existe relaciÃ³n para esa pareja (en esta u otra direcciÃ³n).');
    else alert(error.message || 'Error al crear el enlace');
    return;
  }
  await loadState();
}

async function removeUser(u){
  const { error } = await supabase.from('users').delete().eq('handle', u);
  if(error) return alert(error.message);
  await loadState();
}
async function removeEdge(a,b){
  const { error } = await supabase.from('edges').delete().eq('from', a).eq('to', b);
  if(error) return alert(error.message);
  await loadState();
}

function candidatePartners(u){
  return state.users.filter(v => v!==u && !hasAnyRelation(u,v));
}

function analyze(){
  const sel = Array.from($('#focusUser').selectedOptions).map(o => o.value);
  $('#analysis').innerHTML = '';
  sel.forEach(u => {
    $('#analysis').innerHTML += `
      <h4>${u}</h4>
      <div>
        Ha escrito a: ${outNeighbors(u).map(x => `<span class="chip">${x}</span>`).join(' ') || '(ninguno)'}<br>
        Ha recibido de: ${inNeighbors(u).map(x => `<span class="chip">${x}</span>`).join(' ') || '(ninguno)'}<br>
        <b>Puede interactuar con:</b> ${candidatePartners(u).map(x => `<span class="chip">${x}</span>`).join(' ') || '(ninguno)'}
      </div>`;
  });
}

$('#formUser').addEventListener('submit', async e => {
  e.preventDefault();
  const v = $('#userName').value;
  $('#userName').value = '';
  try { await ensureUser(v); await loadState(); } catch(err){ alert(err.message); }
});
$('#formEdge').addEventListener('submit', async e => {
  e.preventDefault();
  try { await addEdge($('#fromUser').value, $('#toUser').value); } catch(err){ alert(err.message); }
});
$('#btnAnalyze').addEventListener('click', analyze);

loadState();
</script>
</body>
</html>

</html>

