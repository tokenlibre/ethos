<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Triangulador </title>
<style>
  body{margin:0;background:#0b1220;color:#e5e7eb;font:15px system-ui}
  .wrap{max-width:1000px;margin:0 auto;padding:16px}
  .card{background:#0f172a;border:1px solid #1c2b3c;border-radius:12px;padding:12px;margin-bottom:12px}
  input,select,button{border-radius:8px;border:1px solid #1c2b3c;background:#0a1320;color:#e5e7eb;padding:6px 10px;font:inherit}
  .btn{cursor:pointer;background:#0e2333}
  .btn-ok{background:#0f2b23}
  .mono{font-family:monospace}
  .chip{display:inline-block;margin:2px 6px 2px 0;padding:4px 8px;border:1px solid #1c2b3c;border-radius:999px;font-size:12px}
  .muted{color:#9fb0c2}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  details summary{cursor:pointer}
</style>
</head>
<body>
<header class="wrap"><h1>üî∫ Triangulador (no rec√≠proco)</h1></header>
<main class="wrap">
  <section class="card">
    <h3>Usuarios</h3>
    <form id="formUser" class="row">
      <input id="userName" placeholder="@usuario" required>
      <button class="btn-ok">A√±adir</button>
    </form>
    <div id="userStats" class="muted" style="margin-top:6px">
      Total de usuarios insertados: <b><span id="userCount">0</span></b>
    </div>
    <div id="userList" style="margin-top:8px"></div>
  </section>

  <section class="card">
    <h3>Enlaces (parejas ‚áÑ y buscador)</h3>

    <form id="formEdge" class="row" style="margin-bottom:8px">
      <select id="fromUser" required></select> ‚áÑ <select id="toUser" required></select>
      <button class="btn-ok">Crear</button>
    </form>

    <div class="row" style="margin-bottom:8px">
      <label for="searchUser" class="muted">B√∫squeda por usuario:</label>
      <select id="searchUser" style="min-width:220px"></select>
      <button class="btn" id="btnSearch">Buscar</button>
    </div>
    <div id="searchResults" class="muted">(elige un usuario y pulsa ‚ÄúBuscar‚Äù)</div>

    <details style="margin-top:12px">
      <summary class="muted">Mostrar todas las parejas registradas (opcional)</summary>
      <div id="edgeTableWrap" style="margin-top:8px"></div>
    </details>
  </section>

  <section class="card">
    <h3>Consulta: con qui√©n has interactuado y con qui√©n a√∫n no</h3>
    <div class="row">
      <select id="focusUser" multiple size="6" style="min-width:240px;flex:1"></select>
      <button class="btn" id="btnAnalyze">Analizar</button>
    </div>
    <div id="analysis" style="margin-top:8px"></div>
  </section>
</main>

<!-- Supabase JS (v2) -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
// ‚öôÔ∏è Configura tu proyecto Supabase:
const SUPABASE_URL = 'https://xlgejufrchzrjwsqbosw.supabase.co';          // ej: https://abcd.supabase.co
const SUPABASE_ANON_KEY = 'AKfycbwDkMZoisVe8wBuPBP_wO4ZN0pDCJtJN32WhB_TQy4Uc3V9iVIIQbFNUBnGxBjpX7vaSw';  // desde Settings ‚Üí API
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = s => document.querySelector(s);
let state = { users: [], edges: [] };

function norm(u){
  u = (u || '').trim();
  if(!u) return '';
  if(!u.startsWith('@')) u = '@' + u;
  return u.toLowerCase();
}

async function loadState(){
  const { data: users, error: e1 } = await supabase.from('users').select('handle').order('handle');
  if(e1) throw e1;
  const { data: edges, error: e2 } = await supabase.from('edges').select('"from","to"').order('from');
  if(e2) throw e2;
  state.users = (users || []).map(r => r.handle);
  state.edges = edges || [];
  renderUsers(); renderEdges(); fillSelects();
}

function hasEdge(a,b){ return state.edges.some(e => e.from===a && e.to===b); }
function hasAnyRelation(a,b){ return hasEdge(a,b) || hasEdge(b,a); }
function outNeighbors(u){ return state.edges.filter(e => e.from===u).map(e => e.to); }
function inNeighbors(u){ return state.edges.filter(e => e.to===u).map(e => e.from); }

function renderUsers(){
  $('#userCount').textContent = state.users.length;
  $('#userList').innerHTML = state.users
    .map(u => `<span class="mono">${u}</span> <button onclick="removeUser('${u}')">x</button>`)
    .join(' ');
}

// üëâ mostramos parejas √∫nicas como A ‚áÑ B
function renderEdges(){
  const pairs = new Map(); // key = a|b (ordenados)
  state.edges.forEach(e => {
    const a = e.from, b = e.to;
    const [x,y] = [a,b].sort();
    pairs.set(`${x}|${y}`, {a:x, b:y});
  });
  const all = Array.from(pairs.values())
    .map(p => `<div class="mono">${p.a} ‚áÑ ${p.b} <button onclick="removePair('${p.a}','${p.b}')">x</button></div>`)
    .join('');
  $('#edgeTableWrap').innerHTML = all || '<div class="mono">(sin enlaces)</div>';
}

function fillSelects(){
  ['fromUser','toUser','focusUser','searchUser'].forEach(id => {
    const el = $('#'+id);
    if(!el) return;
    el.innerHTML = state.users.map(u => `<option value="${u}">${u}</option>`).join('');
  });
}

async function ensureUser(u){
  u = norm(u); if(!u) return;
  // INSERT ignorando duplicados (no requiere policy UPDATE)
  const { error } = await supabase
    .from('users')
    .insert({ handle: u }, { ignoreDuplicates: true });
  if(error && error.code !== '23505') throw error;
}

async function addEdge(a,b){
  a = norm(a); b = norm(b); if(!a || !b) return;
  if(a === b){ alert('No se permiten bucles A‚áÑA'); return; }
  await ensureUser(a); await ensureUser(b);
  const { error } = await supabase.from('edges').insert({ from: a, to: b });
  if(error){
    if(error.code === '23505') alert('Ya existe relaci√≥n para esa pareja (en esta u otra direcci√≥n).');
    else alert(error.message || 'Error al crear el enlace');
    return;
  }
  await loadState();
}

async function removeUser(u){
  const { error } = await supabase.from('users').delete().eq('handle', u);
  if(error) return alert(error.message);
  await loadState();
}

// Borrar pareja √∫nica (si existiera en una direcci√≥n u otra)
async function removePair(a,b){
  const { error: e1 } = await supabase.from('edges').delete().eq('from', a).eq('to', b);
  const { error: e2 } = await supabase.from('edges').delete().eq('from', b).eq('to', a);
  if(e1 && e2) return alert((e1 && e1.message) || (e2 && e2.message));
  await loadState();
}

async function removeEdge(a,b){
  const { error } = await supabase.from('edges').delete().eq('from', a).eq('to', b);
  if(error) return alert(error.message);
  await loadState();
}

function candidatePartners(u){
  return state.users.filter(v => v!==u && !hasAnyRelation(u,v));
}

function analyze(){
  const sel = Array.from($('#focusUser').selectedOptions).map(o => o.value);
  $('#analysis').innerHTML = '';
  sel.forEach(u => {
    $('#analysis').innerHTML += `
      <h4>${u}</h4>
      <div>
        Ha interactuado con (ha escrito a): ${outNeighbors(u).map(x => `<span class="chip">${x}</span>`).join(' ') || '(nadie)'}<br>
        Ha interactuado con (ha recibido de): ${inNeighbors(u).map(x => `<span class="chip">${x}</span>`).join(' ') || '(nadie)'}<br>
        <b>A√∫n no ha interactuado con:</b> ${candidatePartners(u).map(x => `<span class="chip">${x}</span>`).join(' ') || '(nadie)'}
      </div>`;
  });
}

function searchByUser(){
  const u = $('#searchUser').value;
  if(!u){ $('#searchResults').innerHTML = '(elige un usuario)'; return; }
  const outs = outNeighbors(u);
  const inns = inNeighbors(u);
  $('#searchResults').innerHTML = `
    <div>Ha escrito a: ${outs.map(x => `<span class="chip">${x}</span>`).join(' ') || '(nadie)'}</div>
    <div>Ha recibido de: ${inns.map(x => `<span class="chip">${x}</span>`).join(' ') || '(nadie)'}</div>
  `;
}

$('#formUser').addEventListener('submit', async e => {
  e.preventDefault();
  const v = $('#userName').value;
  $('#userName').value = '';
  try { await ensureUser(v); await loadState(); } catch(err){ alert(err.message); }
});
$('#formEdge').addEventListener('submit', async e => {
  e.preventDefault();
  try { await addEdge($('#fromUser').value, $('#toUser').value); } catch(err){ alert(err.message); }
});
$('#btnAnalyze').addEventListener('click', analyze);
$('#btnSearch').addEventListener('click', e => { e.preventDefault(); searchByUser(); });

// Carga inicial
loadState();
</script>
</body>
</html>


</html>

